---
import BaseLayout from '../../layouts/BaseLayout.astro';
import MovieGrid from '../../components/MovieGrid.svelte';
import { discoverMovies } from '../../lib/tmdb';

// Fetch multiple pages for more movies
const [page1, page2, page3] = await Promise.all([
  discoverMovies({
    'primary_release_date.gte': '2026-01-01',
    'primary_release_date.lte': '2026-12-31',
    sort_by: 'vote_average.desc',
    'vote_count.gte': '10',
    page: '1'
  }),
  discoverMovies({
    'primary_release_date.gte': '2026-01-01',
    'primary_release_date.lte': '2026-12-31',
    sort_by: 'vote_average.desc',
    'vote_count.gte': '10',
    page: '2'
  }),
  discoverMovies({
    'primary_release_date.gte': '2026-01-01',
    'primary_release_date.lte': '2026-12-31',
    sort_by: 'popularity.desc',
    page: '1'
  })
]);

const allResults = [
  ...(page1?.results || []),
  ...(page2?.results || []),
  ...(page3?.results || [])
];

// Remove duplicates
const seen = new Set();
const uniqueResults = allResults.filter((m: any) => {
  if (seen.has(m.id)) return false;
  seen.add(m.id);
  return true;
});

const movies = uniqueResults.map((m: any) => ({
  id: m.id,
  tmdb_id: m.id,
  title: m.title,
  poster_path: m.poster_path,
  backdrop_path: m.backdrop_path,
  vote_average: m.vote_average,
  year: m.release_date ? new Date(m.release_date).getFullYear() : null,
  type: 'movie' as const
}));
---

<BaseLayout
  title="Top Movies of 2026 - Highest Rated Films"
  description="Discover the highest rated movies of 2026. Browse the best films released this year."
>
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex items-center justify-between mb-8">
      <div>
        <h1 class="text-2xl md:text-4xl font-bold text-gray-900 dark:text-white">
          Top Movies of 2026
        </h1>
        <p class="mt-2 text-gray-600 dark:text-gray-400">
          The highest rated films released in 2026
        </p>
      </div>
      <span class="px-4 py-2 rounded-full text-sm font-bold bg-amber-500 text-black">
        2026
      </span>
    </div>

    <MovieGrid client:load items={movies} />

    {movies.length === 0 && (
      <div class="text-center py-12 text-gray-600 dark:text-gray-400">
        <p>No movies found for 2026 yet. Check back later!</p>
      </div>
    )}
  </section>
</BaseLayout>
