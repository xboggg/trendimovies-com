---
import BaseLayout from '../../layouts/BaseLayout.astro';
import VideoPlayer from '../../components/VideoPlayer.svelte';
import DownloadSection from '../../components/DownloadSection.svelte';
import ContentRow from '../../components/ContentRow.svelte';
import { supabase, getPosterUrl, getBackdropUrl, getProfileUrl, formatRuntime, formatDate, getLanguageName } from '../../lib/supabase';
import { Star, Clock, Calendar, Globe, Play } from 'lucide-svelte';

const { slug } = Astro.params;

// Fetch movie first (required for other queries)
const { data: movie, error } = await supabase
  .from('movies')
  .select('*')
  .eq('slug', slug)
  .single();

if (error || !movie) {
  return Astro.redirect('/404');
}

// Fetch download links and similar movies in parallel
const [downloadResult, similarResult] = await Promise.all([
  supabase
    .from('download_links')
    .select('*')
    .eq('content_type', 'movie')
    .eq('content_id', movie.id)
    .eq('is_active', true),

  supabase
    .from('movies')
    .select('id, title, slug, poster_path, vote_average, year')
    .neq('id', movie.id)
    .order('popularity', { ascending: false })
    .limit(12),

  // Fire and forget view count update (don't wait for it)
  supabase
    .from('movies')
    .update({ view_count: (movie.view_count || 0) + 1 })
    .eq('id', movie.id)
]);

const downloadLinks = downloadResult.data;
const similarMovies = similarResult.data;

// Transform similar movies
const similar = (similarMovies || []).map(m => ({ ...m, type: 'movie' as const }));

// Get directors and writers
const directors = (movie.crew_data || []).filter((c: any) => c.job === 'Director');
const writers = (movie.crew_data || []).filter((c: any) => ['Writer', 'Screenplay'].includes(c.job));

// Format budget and revenue
function formatMoney(amount: number | null): string {
  if (!amount) return 'N/A';
  return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(amount);
}
---

<BaseLayout
  title={movie.title}
  description={movie.overview || `Watch ${movie.title} online for free in HD quality.`}
  image={getBackdropUrl(movie.backdrop_path)}
  type="video.movie"
>
  <!-- Backdrop Header -->
  <section class="relative">
    <!-- Background -->
    <div class="absolute inset-0 h-[300px] md:h-[500px]">
      <img
        src={getBackdropUrl(movie.backdrop_path)}
        alt={movie.title}
        class="w-full h-full object-cover"
      />
      <div class="absolute inset-0 bg-gradient-to-t from-[var(--bg-primary)] via-[var(--bg-primary)]/80 to-transparent"></div>
    </div>

    <!-- Content -->
    <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-8 pb-8 md:pb-12">
      <div class="flex flex-col md:flex-row gap-5 md:gap-8">
        <!-- Poster -->
        <div class="flex-shrink-0 w-48 md:w-64 mx-auto md:mx-0">
          <img
            src={getPosterUrl(movie.poster_path)}
            alt={movie.title}
            class="w-full rounded-lg shadow-2xl"
          />
        </div>

        <!-- Info -->
        <div class="flex-1">
          <h1 class="text-2xl md:text-4xl lg:text-5xl font-bold mb-2 md:mb-4" style="color: var(--text-primary);">
            {movie.title}
            {movie.year && <span class="text-xl md:text-2xl font-normal" style="color: var(--text-secondary);"> ({movie.year})</span>}
          </h1>

          {movie.tagline && (
            <p class="text-base md:text-lg italic mb-3 md:mb-4" style="color: var(--text-secondary);">
              "{movie.tagline}"
            </p>
          )}

          <!-- Meta Info -->
          <div class="flex flex-wrap items-center gap-3 md:gap-4 mb-4 md:mb-6 text-sm" style="color: var(--text-secondary);">
            <div class="flex items-center gap-1">
              <Star size={16} class="text-yellow-400" fill="currentColor" />
              <span class="font-semibold" style="color: var(--text-primary);">{movie.vote_average.toFixed(1)}</span>
              <span class="text-xs md:text-sm">({movie.vote_count} votes)</span>
            </div>
            {movie.runtime && (
              <div class="flex items-center gap-1">
                <Clock size={16} />
                <span>{formatRuntime(movie.runtime)}</span>
              </div>
            )}
            {movie.release_date && (
              <div class="flex items-center gap-1">
                <Calendar size={16} />
                <span>{formatDate(movie.release_date)}</span>
              </div>
            )}
            <div class="flex items-center gap-1">
              <Globe size={16} />
              <span>{getLanguageName(movie.original_language)}</span>
            </div>
          </div>

          <!-- Genres -->
          {movie.genres && movie.genres.length > 0 && (
            <div class="flex flex-wrap gap-2 mb-4 md:mb-6">
              {movie.genres.map((genre: any) => (
                <a
                  href={`/genre/${genre.name.toLowerCase().replace(/\s+/g, '-')}`}
                  class="genre-chip"
                >
                  {genre.name}
                </a>
              ))}
            </div>
          )}

          <!-- Watch Providers -->
          {movie.watch_providers?.flatrate && (
            <div class="flex items-center gap-3 mb-4 md:mb-6">
              <span class="text-sm" style="color: var(--text-secondary);">Available on:</span>
              <div class="flex gap-2">
                {movie.watch_providers.flatrate.slice(0, 5).map((provider: any) => (
                  <img
                    src={`https://image.tmdb.org/t/p/w45${provider.logo_path}`}
                    alt={provider.provider_name}
                    title={provider.provider_name}
                    class="w-8 h-8 rounded"
                  />
                ))}
              </div>
            </div>
          )}

          <!-- Overview -->
          <div class="mb-4 md:mb-6">
            <h3 class="font-semibold mb-1.5 md:mb-2" style="color: var(--text-primary);">Synopsis</h3>
            <p class="leading-relaxed text-sm md:text-base" style="color: var(--text-primary); opacity: 0.85;">
              {movie.overview || 'No synopsis available.'}
            </p>
          </div>

          <!-- Directors & Writers -->
          <div class="grid grid-cols-2 gap-3 md:gap-4">
            {directors.length > 0 && (
              <div>
                <h4 class="text-sm font-semibold" style="color: var(--text-muted);">Director</h4>
                <p style="color: var(--text-primary);">{directors.map((d: any) => d.name).join(', ')}</p>
              </div>
            )}
            {writers.length > 0 && (
              <div>
                <h4 class="text-sm font-semibold" style="color: var(--text-muted);">Writers</h4>
                <p style="color: var(--text-primary);">{writers.slice(0, 3).map((w: any) => w.name).join(', ')}</p>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Video Player Section -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2" style="color: var(--text-primary);">
      <Play size={24} />
      Watch Now
    </h2>
    <VideoPlayer
      client:load
      tmdbId={movie.tmdb_id}
      imdbId={movie.imdb_id}
      type="movie"
    />
  </section>

  <!-- Download Section -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <DownloadSection
      client:load
      links={downloadLinks || []}
      contentId={movie.id}
      contentType="movie"
    />
  </section>

  <!-- Cast Section -->
  {movie.cast_data && movie.cast_data.length > 0 && (
    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <h2 class="text-2xl font-bold mb-4" style="color: var(--text-primary);">Cast</h2>
      <div class="flex gap-4 overflow-x-auto hide-scrollbar pb-4">
        {movie.cast_data.slice(0, 12).map((actor: any) => (
          <a
            href={`/person/${actor.id}`}
            class="flex-shrink-0 w-32 text-center group"
          >
            <img
              src={getProfileUrl(actor.profile_path)}
              alt={actor.name}
              class="w-24 h-24 rounded-full mx-auto object-cover mb-2 transition-transform group-hover:scale-105"
            />
            <p class="font-medium text-sm line-clamp-1 group-hover:underline" style="color: var(--text-primary);">{actor.name}</p>
            <p class="text-xs line-clamp-1" style="color: var(--text-secondary);">{actor.character}</p>
          </a>
        ))}
      </div>
    </section>
  )}

  <!-- Trailer Section -->
  {movie.trailer_key && (
    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <h2 class="text-2xl font-bold mb-4" style="color: var(--text-primary);">Trailer</h2>
      <div class="video-container rounded-lg overflow-hidden">
        <iframe
          src={`https://www.youtube.com/embed/${movie.trailer_key}`}
          allowfullscreen
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          title="Trailer"
        ></iframe>
      </div>
    </section>
  )}

  <!-- Movie Details -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h2 class="text-2xl font-bold mb-4" style="color: var(--text-primary);">Details</h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 p-6 rounded-lg" style="background-color: var(--bg-card);">
      <div>
        <h4 class="text-sm font-semibold" style="color: var(--text-muted);">Original Title</h4>
        <p style="color: var(--text-primary);">{movie.original_title || movie.title}</p>
      </div>
      <div>
        <h4 class="text-sm font-semibold" style="color: var(--text-muted);">Status</h4>
        <p style="color: var(--text-primary);">{movie.status}</p>
      </div>
      <div>
        <h4 class="text-sm font-semibold" style="color: var(--text-muted);">Budget</h4>
        <p style="color: var(--text-primary);">{formatMoney(movie.budget)}</p>
      </div>
      <div>
        <h4 class="text-sm font-semibold" style="color: var(--text-muted);">Revenue</h4>
        <p style="color: var(--text-primary);">{formatMoney(movie.revenue)}</p>
      </div>
      {movie.production_companies && movie.production_companies.length > 0 && (
        <div class="col-span-2">
          <h4 class="text-sm font-semibold" style="color: var(--text-muted);">Production</h4>
          <p style="color: var(--text-primary);">{movie.production_companies.slice(0, 3).map((c: any) => c.name).join(', ')}</p>
        </div>
      )}
    </div>
  </section>

  <!-- Similar Movies -->
  {similar.length > 0 && (
    <ContentRow
      client:visible
      title="You May Also Like"
      items={similar}
    />
  )}
</BaseLayout>
