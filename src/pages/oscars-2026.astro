---
import BaseLayout from '../layouts/BaseLayout.astro';
import { searchMovies, getMovieDetails } from '../lib/tmdb';

// 2026 Oscar Nominated Films
const oscarNominees = [
  // Best Picture
  { title: 'Sinners', nominations: 16, categories: ['Best Picture', 'Best Director', 'Best Actor'] },
  { title: 'One Battle After Another', nominations: 13, categories: ['Best Picture', 'Best Director'] },
  { title: 'Bugonia', nominations: 0, categories: ['Best Picture'] },
  { title: 'F1', nominations: 0, categories: ['Best Picture'] },
  { title: 'Frankenstein', nominations: 0, categories: ['Best Picture'] },
  { title: 'Hamnet', nominations: 0, categories: ['Best Picture'] },
  { title: 'Marty Supreme', nominations: 0, categories: ['Best Picture'] },
  { title: 'The Secret Agent', nominations: 0, categories: ['Best Picture'] },
  { title: 'Sentimental Value', nominations: 0, categories: ['Best Picture'] },
  { title: 'Train Dreams', nominations: 0, categories: ['Best Picture'] },
  // Other nominated films
  { title: 'Avatar: Fire and Ash', nominations: 0, categories: ['Visual Effects', 'Sound'] },
  { title: 'Blue Moon', nominations: 0, categories: ['Best Actress'] },
  { title: 'Elio', nominations: 0, categories: ['Animated Feature'] },
  { title: 'Jurassic World Rebirth', nominations: 0, categories: ['Visual Effects'] },
  { title: 'Kokuho', nominations: 0, categories: ['International Feature'] },
  { title: 'The Ugly Stepsister', nominations: 0, categories: ['Animated Feature'] },
  { title: 'Zootopia 2', nominations: 0, categories: ['Animated Feature'] },
  { title: 'The Smashing Machine', nominations: 0, categories: ['Best Actor'] },
  { title: 'Weapons', nominations: 0, categories: ['Original Screenplay'] },
];

// Search TMDB for each movie and get details
async function getMovieData(title: string) {
  try {
    const searchResult = await searchMovies(title, 1);
    if (searchResult.results && searchResult.results.length > 0) {
      // Find 2025/2026 movie or take first result
      const movie = searchResult.results.find((m: any) => {
        const year = m.release_date ? new Date(m.release_date).getFullYear() : 0;
        return year >= 2024 && year <= 2026;
      }) || searchResult.results[0];

      // Get full details
      const details = await getMovieDetails(movie.id);
      return {
        ...movie,
        runtime: details?.runtime,
        genres: details?.genres || []
      };
    }
  } catch (e) {
    console.error(`Failed to fetch ${title}:`, e);
  }
  return null;
}

// Fetch all nominee data
const nomineeDataPromises = oscarNominees.map(async (nominee) => {
  const movieData = await getMovieData(nominee.title);
  return {
    ...nominee,
    tmdb: movieData
  };
});

const nominees = await Promise.all(nomineeDataPromises);
const validNominees = nominees.filter(n => n.tmdb);

// Separate Best Picture from others
const bestPictureNominees = validNominees.filter(n => n.categories.includes('Best Picture'));
const otherNominees = validNominees.filter(n => !n.categories.includes('Best Picture'));

function getPosterUrl(path: string | null): string {
  if (!path) return '/images/no-poster.svg';
  return `https://image.tmdb.org/t/p/w500${path}`;
}

function getBackdropUrl(path: string | null): string {
  if (!path) return '/images/no-backdrop.svg';
  return `https://image.tmdb.org/t/p/original${path}`;
}
---

<BaseLayout
  title="2026 Oscar Nominations - Academy Awards"
  description="Complete list of 2026 Oscar nominated films. The 98th Academy Awards ceremony - March 15, 2026."
>
  <!-- Hero Section -->
  <section class="relative h-[50vh] min-h-[400px] overflow-hidden">
    <div class="absolute inset-0">
      <img
        src={validNominees[0]?.tmdb?.backdrop_path ? getBackdropUrl(validNominees[0].tmdb.backdrop_path) : '/images/oscars-bg.jpg'}
        alt="Oscars 2026"
        class="w-full h-full object-cover"
      />
      <div class="absolute inset-0 bg-gradient-to-t from-black via-black/70 to-black/30"></div>
    </div>

    <div class="relative h-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center">
      <div class="text-center w-full">
        <div class="inline-flex items-center gap-2 mb-4">
          <span class="text-4xl">ğŸ†</span>
        </div>
        <h1 class="text-4xl md:text-6xl font-black text-white mb-4">
          2026 Oscar Nominations
        </h1>
        <p class="text-xl text-gray-300 mb-2">98th Academy Awards</p>
        <p class="text-amber-400 font-semibold">March 15, 2026</p>
      </div>
    </div>
  </section>

  <!-- Best Picture Nominees -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h2 class="text-2xl md:text-3xl font-bold mb-8 flex items-center gap-3" style="color: var(--text-primary);">
      <span class="text-amber-400">ğŸ¬</span>
      Best Picture Nominees
    </h2>

    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6">
      {bestPictureNominees.map((nominee) => (
        <a
          href={`/movie/${nominee.tmdb.id}`}
          class="group relative rounded-lg overflow-hidden transition-transform hover:scale-105"
          style="background-color: var(--bg-card);"
        >
          <div class="aspect-[2/3] relative">
            <img
              src={getPosterUrl(nominee.tmdb.poster_path)}
              alt={nominee.title}
              class="w-full h-full object-cover"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>

            {nominee.nominations > 0 && (
              <div class="absolute top-2 right-2 px-2 py-1 rounded-full text-xs font-bold bg-amber-500 text-black">
                {nominee.nominations} noms
              </div>
            )}

            <div class="absolute bottom-0 left-0 right-0 p-3 transform translate-y-full group-hover:translate-y-0 transition-transform">
              <div class="flex items-center gap-1 text-amber-400 text-sm">
                <span>â­</span>
                <span>{nominee.tmdb.vote_average?.toFixed(1)}</span>
              </div>
            </div>
          </div>

          <div class="p-3">
            <h3 class="font-semibold text-sm line-clamp-2" style="color: var(--text-primary);">
              {nominee.title}
            </h3>
            <p class="text-xs mt-1" style="color: var(--text-muted);">
              {nominee.tmdb.release_date ? new Date(nominee.tmdb.release_date).getFullYear() : 'TBA'}
            </p>
          </div>
        </a>
      ))}
    </div>
  </section>

  <!-- Other Nominated Films -->
  {otherNominees.length > 0 && (
    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <h2 class="text-2xl md:text-3xl font-bold mb-8 flex items-center gap-3" style="color: var(--text-primary);">
        <span class="text-amber-400">ğŸ­</span>
        Other Nominated Films
      </h2>

      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
        {otherNominees.map((nominee) => (
          <a
            href={`/movie/${nominee.tmdb.id}`}
            class="group relative rounded-lg overflow-hidden transition-transform hover:scale-105"
            style="background-color: var(--bg-card);"
          >
            <div class="aspect-[2/3] relative">
              <img
                src={getPosterUrl(nominee.tmdb.poster_path)}
                alt={nominee.title}
                class="w-full h-full object-cover"
              />
            </div>

            <div class="p-2">
              <h3 class="font-medium text-xs line-clamp-2" style="color: var(--text-primary);">
                {nominee.title}
              </h3>
              <p class="text-xs mt-1 line-clamp-1" style="color: var(--text-muted);">
                {nominee.categories[0]}
              </p>
            </div>
          </a>
        ))}
      </div>
    </section>
  )}

  <!-- Leading Nominees Section -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h2 class="text-2xl md:text-3xl font-bold mb-8 flex items-center gap-3" style="color: var(--text-primary);">
      <span class="text-amber-400">ğŸ†</span>
      Leading Nominees
    </h2>

    <div class="grid md:grid-cols-2 gap-6">
      {validNominees.filter(n => n.nominations > 0).sort((a, b) => b.nominations - a.nominations).slice(0, 4).map((nominee, index) => (
        <a
          href={`/movie/${nominee.tmdb.id}`}
          class="flex gap-4 p-4 rounded-xl transition-colors hover:bg-[var(--bg-hover)]"
          style="background-color: var(--bg-card); border: 1px solid var(--border);"
        >
          <div class="flex-shrink-0 w-24">
            <img
              src={getPosterUrl(nominee.tmdb.poster_path)}
              alt={nominee.title}
              class="w-full rounded-lg"
            />
          </div>
          <div class="flex-1">
            <div class="flex items-start justify-between gap-2">
              <h3 class="font-bold text-lg" style="color: var(--text-primary);">
                {nominee.title}
              </h3>
              <span class="flex-shrink-0 px-3 py-1 rounded-full text-sm font-bold bg-amber-500 text-black">
                {nominee.nominations} nominations
              </span>
            </div>
            <p class="text-sm mt-2 line-clamp-2" style="color: var(--text-secondary);">
              {nominee.tmdb.overview}
            </p>
            <div class="flex items-center gap-4 mt-3 text-sm" style="color: var(--text-muted);">
              <span class="flex items-center gap-1">
                <span class="text-amber-400">â­</span>
                {nominee.tmdb.vote_average?.toFixed(1)}
              </span>
              {nominee.tmdb.runtime && (
                <span>{Math.floor(nominee.tmdb.runtime / 60)}h {nominee.tmdb.runtime % 60}m</span>
              )}
            </div>
          </div>
        </a>
      ))}
    </div>
  </section>
</BaseLayout>
