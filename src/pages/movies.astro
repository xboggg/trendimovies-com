---
import BaseLayout from '../layouts/BaseLayout.astro';
import MovieCard from '../components/MovieCard.svelte';
import { discoverMovies, getMovieGenres } from '../lib/tmdb';

// Get query params
const page = parseInt(Astro.url.searchParams.get('page') || '1');
const sort = Astro.url.searchParams.get('sort') || 'popularity.desc';
const genre = Astro.url.searchParams.get('genre') || '';
const year = Astro.url.searchParams.get('year') || '';

// Map sort options to TMDB sort_by values
const sortMap: Record<string, string> = {
  'latest': 'primary_release_date.desc',
  'popular': 'popularity.desc',
  'rating': 'vote_average.desc',
  'title': 'title.asc'
};

const sortBy = sortMap[sort] || 'popularity.desc';

// Build TMDB params
const baseParams: Record<string, string> = {
  sort_by: sortBy,
  'vote_count.gte': '10'
};

if (genre) {
  baseParams.with_genres = genre;
}

if (year) {
  baseParams.primary_release_year = year;
}

// Fetch 2 pages to get 30+ movies (TMDB returns 20 per page)
const tmdbPage1 = (page - 1) * 2 + 1;
const tmdbPage2 = tmdbPage1 + 1;

const [response1, response2] = await Promise.all([
  discoverMovies({ ...baseParams, page: tmdbPage1.toString() }),
  discoverMovies({ ...baseParams, page: tmdbPage2.toString() })
]);

// Combine and take first 30
const allMovies = [...(response1.results || []), ...(response2.results || [])];
const movies = allMovies.slice(0, 30);
const totalPages = Math.min(Math.ceil((response1.total_pages || 1) / 2), 250);

// Fetch genre list from TMDB
const genres = await getMovieGenres();

// Years for filter - go back to 1940
const currentYear = new Date().getFullYear();
const years = Array.from({ length: currentYear - 1940 + 1 }, (_, i) => currentYear - i);

function transformToItem(movie: any) {
  return {
    id: movie.id,
    tmdb_id: movie.id,
    title: movie.title,
    poster_path: movie.poster_path,
    vote_average: movie.vote_average,
    year: movie.release_date ? new Date(movie.release_date).getFullYear() : null,
    type: 'movie' as const
  };
}
---

<BaseLayout title="Movies" description="Browse all movies available for streaming">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8">
      <h1 class="text-3xl font-bold mb-4 md:mb-0" style="color: var(--text-primary);">Movies</h1>

      <!-- Filters -->
      <div class="flex flex-wrap gap-3">
        <select
          id="sort-select"
          class="px-3 py-2 rounded-lg text-sm"
          style="background-color: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border);"
        >
          <option value="popular" selected={sort === 'popular' || sort === 'popularity.desc'}>Popular</option>
          <option value="latest" selected={sort === 'latest'}>Latest</option>
          <option value="rating" selected={sort === 'rating'}>Top Rated</option>
          <option value="title" selected={sort === 'title'}>A-Z</option>
        </select>

        <select
          id="genre-select"
          class="px-3 py-2 rounded-lg text-sm"
          style="background-color: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border);"
        >
          <option value="">All Genres</option>
          {genres.map(g => (
            <option value={g.id} selected={genre === g.id.toString()}>{g.name}</option>
          ))}
        </select>

        <select
          id="year-select"
          class="px-3 py-2 rounded-lg text-sm"
          style="background-color: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border);"
        >
          <option value="">All Years</option>
          {years.map(y => (
            <option value={y} selected={year === y.toString()}>{y}</option>
          ))}
        </select>
      </div>
    </div>

    <!-- Movie Grid -->
    {movies.length > 0 ? (
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 lg:grid-cols-6 gap-4">
        {movies.map(movie => (
          <MovieCard client:visible item={transformToItem(movie)} />
        ))}
      </div>
    ) : (
      <div class="text-center py-16">
        <p style="color: var(--text-secondary);">No movies found</p>
      </div>
    )}

    <!-- Pagination -->
    {totalPages > 1 && (
      <div class="flex justify-center mt-8 gap-2">
        {page > 1 && (
          <a
            href={`/movies?page=${page - 1}&sort=${sort}&genre=${genre}&year=${year}`}
            class="px-4 py-2 rounded-lg"
            style="background-color: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border);"
          >
            Previous
          </a>
        )}

        <span class="px-4 py-2" style="color: var(--text-secondary);">
          Page {page} of {totalPages}
        </span>

        {page < totalPages && (
          <a
            href={`/movies?page=${page + 1}&sort=${sort}&genre=${genre}&year=${year}`}
            class="px-4 py-2 rounded-lg"
            style="background-color: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border);"
          >
            Next
          </a>
        )}
      </div>
    )}
  </div>

  <script>
    function updateUrl() {
      const sort = (document.getElementById('sort-select') as HTMLSelectElement).value;
      const genre = (document.getElementById('genre-select') as HTMLSelectElement).value;
      const year = (document.getElementById('year-select') as HTMLSelectElement).value;

      const params = new URLSearchParams();
      if (sort && sort !== 'popular') params.set('sort', sort);
      if (genre) params.set('genre', genre);
      if (year) params.set('year', year);

      window.location.href = '/movies' + (params.toString() ? '?' + params.toString() : '');
    }

    document.getElementById('sort-select')?.addEventListener('change', updateUrl);
    document.getElementById('genre-select')?.addEventListener('change', updateUrl);
    document.getElementById('year-select')?.addEventListener('change', updateUrl);
  </script>
</BaseLayout>
